suite: bow deployment
templates:
  - bow/deployment.yaml
tests:
  - it: renders bow deployment
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-bow
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/bosun-ai/fluyt/bow:latest

---
suite: stern deployment
templates:
  - stern/deployment.yaml
tests:
  - it: renders stern deployment and database env
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-stern
      - equal:
          path: spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.name
          value: postgres-app
      - equal:
          path: spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.key
          value: uri

---
suite: quak deployment
templates:
  - quak/deployment.yaml
tests:
  - it: renders quak deployment
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-quak

---
suite: billing worker
templates:
  - stern/billing-worker.yaml
tests:
  - it: renders billing worker deployment by default
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-stern-billing-worker
      - equal:
          path: spec.template.spec.containers[0].command[0]
          value: bin/thrust

---
suite: stern migrate job
templates:
  - stern/migrate-job.yaml
tests:
  - it: renders stern migration job
    asserts:
      - isKind:
          of: Job
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-stern-migrate
      - equal:
          path: spec.template.spec.containers[0].command[0]
          value: bundle

---
suite: services
templates:
  - bow/service.yaml
  - stern/service.yaml
  - quak/service.yaml
tests:
  - it: renders bow service
    template: bow/service.yaml
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-bow
  - it: renders stern service
    template: stern/service.yaml
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-stern
  - it: renders quak service
    template: quak/service.yaml
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-quak

---
suite: pdbs
templates:
  - pdbs.yaml
tests:
  - it: renders pdbs for bow, stern, quak
    asserts:
      - hasDocuments:
          count: 3
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-bow-pdb
        documentIndex: 0
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-stern-pdb
        documentIndex: 1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-quak-pdb
        documentIndex: 2

---
suite: ingress disabled by default
templates:
  - bow/ingress.yaml
  - stern/ingress.yaml
tests:
  - it: does not render bow ingress
    template: bow/ingress.yaml
    asserts:
      - hasDocuments:
          count: 0
  - it: does not render stern ingress
    template: stern/ingress.yaml
    asserts:
      - hasDocuments:
          count: 0

---
suite: prepull disabled by default
templates:
  - prepull-daemonset.yaml
tests:
  - it: does not render prepull daemonset
    asserts:
      - hasDocuments:
          count: 0

---
suite: image tag override
templates:
  - stern/deployment.yaml
tests:
  - it: overrides stern image tag
    set:
      stern.image.tag: 2025.01.01
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/bosun-ai/fluyt/stern:2025.01.01
