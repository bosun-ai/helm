suite: bow deployment
templates:
  - bow/deployment.yaml
  - bow/configmap.yaml
tests:
  - it: renders bow deployment
    template: bow/deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-bow
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/bosun-ai/fluyt/bow:latest

---
suite: stern deployment
templates:
  - stern/deployment.yaml
  - stern/configmap.yaml
tests:
  - it: renders stern deployment and database env
    template: stern/deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-stern
      - equal:
          path: spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.name
          value: RELEASE-NAME-bosun-postgres-auth
      - equal:
          path: spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.key
          value: baseUrl

---
suite: quak deployment
templates:
  - quak/deployment.yaml
  - quak/configmap.yaml
tests:
  - it: renders quak deployment
    template: quak/deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-quak

---
suite: billing worker
templates:
  - stern/billing-worker.yaml
  - stern/configmap.yaml
tests:
  - it: renders billing worker deployment by default
    template: stern/billing-worker.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-stern-billing-worker
      - equal:
          path: spec.template.spec.containers[0].command[0]
          value: bin/thrust

---
suite: stern migrate job
templates:
  - stern/migrate-job.yaml
  - stern/configmap.yaml
tests:
  - it: renders stern migration job
    template: stern/migrate-job.yaml
    asserts:
      - isKind:
          of: Job
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-stern-migrate
      - equal:
          path: spec.template.spec.containers[0].command[0]
          value: /bin/sh

---
suite: services
templates:
  - bow/service.yaml
  - stern/service.yaml
  - quak/service.yaml
tests:
  - it: renders bow service
    template: bow/service.yaml
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-bow
  - it: renders stern service
    template: stern/service.yaml
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-stern
  - it: renders quak service
    template: quak/service.yaml
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-quak

---
suite: pdbs
templates:
  - pdbs.yaml
tests:
  - it: renders pdbs for bow, stern, quak
    asserts:
      - hasDocuments:
          count: 3
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-bow-pdb
        documentIndex: 0
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-stern-pdb
        documentIndex: 1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-quak-pdb
        documentIndex: 2

---
suite: ingress disabled by default
templates:
  - bow/ingress.yaml
  - stern/ingress.yaml
tests:
  - it: does not render bow ingress
    template: bow/ingress.yaml
    asserts:
      - hasDocuments:
          count: 0
  - it: does not render stern ingress
    template: stern/ingress.yaml
    asserts:
      - hasDocuments:
          count: 0

---
suite: prepull disabled by default
templates:
  - prepull-daemonset.yaml
tests:
  - it: does not render prepull daemonset
    asserts:
      - hasDocuments:
          count: 0

---
suite: ingress enabled
templates:
  - bow/ingress.yaml
  - stern/ingress.yaml
tests:
  - it: renders bow ingress when enabled
    template: bow/ingress.yaml
    set:
      bow.ingress.enabled: true
    asserts:
      - isKind:
          of: Ingress
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-bow
  - it: renders stern ingress when enabled
    template: stern/ingress.yaml
    set:
      stern.ingress.enabled: true
    asserts:
      - isKind:
          of: Ingress
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-stern

---
suite: prepull enabled
templates:
  - prepull-daemonset.yaml
tests:
  - it: renders prepull daemonset when enabled
    set:
      prepull.enabled: true
    asserts:
      - isKind:
          of: DaemonSet
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-image-prepull

---
suite: overprovisioner enabled
templates:
  - overprovisioner.yaml
tests:
  - it: renders priorityclass and deployment when enabled
    set:
      overprovisioner.enabled: true
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: kind
          value: PriorityClass
        documentIndex: 0
      - equal:
          path: metadata.name
          value: overprovisioning-low
        documentIndex: 0
      - equal:
          path: kind
          value: Deployment
        documentIndex: 1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-executor-overprovisioner
        documentIndex: 1

---
suite: storageclass enabled
templates:
  - storageclass.yaml
tests:
  - it: renders storageclass when enabled
    set:
      storageClass.enabled: true
    asserts:
      - isKind:
          of: StorageClass
      - equal:
          path: metadata.name
          value: bosun-executor-encrypted

---
suite: quak executor namespace
templates:
  - quak/rbac.yaml
tests:
  - it: renders executor namespace and rbac
    set:
      quak.executorNamespace.create: true
    asserts:
      - hasDocuments:
          count: 4
      - equal:
          path: kind
          value: Namespace
        documentIndex: 0
      - equal:
          path: metadata.name
          value: tasks
        documentIndex: 0
      - equal:
          path: kind
          value: ServiceAccount
        documentIndex: 1
      - equal:
          path: kind
          value: Role
        documentIndex: 2
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-quak-executor
        documentIndex: 2
      - equal:
          path: metadata.namespace
          value: tasks
        documentIndex: 2
      - equal:
          path: kind
          value: RoleBinding
        documentIndex: 3
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-quak-executor
        documentIndex: 3
      - equal:
          path: metadata.namespace
          value: tasks
        documentIndex: 3

---
suite: stern database url override
templates:
  - stern/deployment.yaml
  - stern/configmap.yaml
tests:
  - it: uses direct database url when set
    template: stern/deployment.yaml
    set:
      stern.database.url: postgresql://user:pass@db.example.com:5432/app
      stern.database.existingSecret: ""
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[0].name
          value: DATABASE_URL
      - equal:
          path: spec.template.spec.containers[0].env[0].value
          value: postgresql://user:pass@db.example.com:5432/app

---
suite: env configmaps
templates:
  - stern/configmap.yaml
  - quak/configmap.yaml
tests:
  - it: renders stern env overrides
    template: stern/configmap.yaml
    set:
      stern.env.EXTRA_SETTING: enabled
    asserts:
      - equal:
          path: data.EXTRA_SETTING
          value: enabled
  - it: renders quak env overrides
    template: quak/configmap.yaml
    set:
      quak.env.EXTRA_SETTING: enabled
    asserts:
      - equal:
          path: data.EXTRA_SETTING
          value: enabled

---
suite: image tag override
templates:
  - stern/deployment.yaml
  - stern/configmap.yaml
tests:
  - it: overrides stern image tag
    template: stern/deployment.yaml
    set:
      stern.image.tag: 2025.01.01
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: ghcr.io/bosun-ai/fluyt/stern:2025.01.01

---
suite: postgres resources
templates:
  - postgres/secret.yaml
  - postgres/deployment.yaml
  - postgres/service.yaml
tests:
  - it: renders postgres secret
    template: postgres/secret.yaml
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-postgres-auth
      - equal:
          path: stringData.baseUrl
          value: postgresql://bosun:bosun@RELEASE-NAME-bosun-postgres:5432/
  - it: renders postgres deployment
    template: postgres/deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-postgres
      - equal:
          path: spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.name
          value: RELEASE-NAME-bosun-postgres-auth
  - it: renders postgres service
    template: postgres/service.yaml
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-postgres

---
suite: postgres pvc disabled
templates:
  - postgres/pvc.yaml
tests:
  - it: does not render postgres pvc by default
    asserts:
      - hasDocuments:
          count: 0

---
suite: redis shared resources
templates:
  - redis/shared.yaml
tests:
  - it: renders redis shared deployment and service
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: kind
          value: Deployment
        documentIndex: 0
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-redis-shared
        documentIndex: 0
      - equal:
          path: kind
          value: Service
        documentIndex: 1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-redis-shared
        documentIndex: 1

---
suite: redis indexing resources
templates:
  - redis/indexing.yaml
tests:
  - it: renders redis indexing deployment and service
    asserts:
      - hasDocuments:
          count: 2
      - equal:
          path: kind
          value: Deployment
        documentIndex: 0
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-redis-indexing
        documentIndex: 0
      - equal:
          path: kind
          value: Service
        documentIndex: 1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-redis-indexing
        documentIndex: 1

---
suite: qdrant resources
templates:
  - qdrant/deployment.yaml
  - qdrant/service.yaml
tests:
  - it: renders qdrant deployment
    template: qdrant/deployment.yaml
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-qdrant
  - it: renders qdrant service
    template: qdrant/service.yaml
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-bosun-qdrant

---
suite: qdrant pvc disabled
templates:
  - qdrant/pvc.yaml
tests:
  - it: does not render qdrant pvc by default
    asserts:
      - hasDocuments:
          count: 0

---
suite: configmap defaults
templates:
  - bow/configmap.yaml
  - stern/configmap.yaml
  - quak/configmap.yaml
tests:
  - it: defaults bow backend url to stern service
    template: bow/configmap.yaml
    asserts:
      - equal:
          path: data.BACKEND_URL
          value: http://RELEASE-NAME-bosun-stern:3000
  - it: defaults stern service urls
    template: stern/configmap.yaml
    asserts:
      - equal:
          path: data.REDIS_URL
          value: redis://RELEASE-NAME-bosun-redis-shared:6379
      - equal:
          path: data.QUAK_URL
          value: http://RELEASE-NAME-bosun-quak:3001
      - equal:
          path: data.ROOT_URL
          value: http://RELEASE-NAME-bosun-stern:3000
  - it: defaults quak service urls
    template: quak/configmap.yaml
    asserts:
      - equal:
          path: data.REDIS_URL
          value: redis://RELEASE-NAME-bosun-redis-shared:6379
      - equal:
          path: data.REDIS_INDEXING_URL
          value: redis://RELEASE-NAME-bosun-redis-indexing:6379
      - equal:
          path: data.QDRANT_URL
          value: http://RELEASE-NAME-bosun-qdrant:6334

---
suite: disable dependencies
templates:
  - postgres/deployment.yaml
  - postgres/service.yaml
  - redis/shared.yaml
  - redis/indexing.yaml
  - qdrant/deployment.yaml
tests:
  - it: does not render dependency resources when disabled
    set:
      postgres.enabled: false
      redis.enabled: false
      qdrant.enabled: false
    asserts:
      - hasDocuments:
          count: 0

---
suite: external service overrides
templates:
  - stern/deployment.yaml
  - stern/configmap.yaml
  - quak/configmap.yaml
tests:
  - it: uses external postgres when bundled postgres disabled
    template: stern/deployment.yaml
    set:
      postgres.enabled: false
      stern.database.url: postgresql://user:pass@db.example.com:5432/
      stern.database.existingSecret: ""
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[0].value
          value: postgresql://user:pass@db.example.com:5432/
  - it: uses external redis and qdrant urls when disabled
    template: quak/configmap.yaml
    set:
      redis.enabled: false
      qdrant.enabled: false
      quak.env.REDIS_URL: redis://redis.example.com:6379
      quak.env.REDIS_INDEXING_URL: redis://redis-index.example.com:6379
      quak.env.QDRANT_URL: http://qdrant.example.com:6334
    asserts:
      - equal:
          path: data.REDIS_URL
          value: redis://redis.example.com:6379
      - equal:
          path: data.REDIS_INDEXING_URL
          value: redis://redis-index.example.com:6379
      - equal:
          path: data.QDRANT_URL
          value: http://qdrant.example.com:6334
  - it: uses external redis url for stern when bundled redis disabled
    template: stern/configmap.yaml
    set:
      redis.enabled: false
      stern.env.REDIS_URL: redis://redis.example.com:6379
    asserts:
      - equal:
          path: data.REDIS_URL
          value: redis://redis.example.com:6379
