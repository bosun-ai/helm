{{- if .Values.activeRecordEncryption.create }}
{{- $secretName := .Values.activeRecordEncryption.secretName -}}
{{- $namespace := include "bosun.namespace" . -}}
{{- $existing := lookup "v1" "Secret" $namespace $secretName -}}
{{- $primary := "" -}}
{{- $deterministic := "" -}}
{{- $salt := "" -}}
{{- if $existing }}
{{- $primary = (index $existing.data "ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY") -}}
{{- $deterministic = (index $existing.data "ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY") -}}
{{- $salt = (index $existing.data "ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT") -}}
{{- if not $primary }}
{{- fail "active record encryption secret exists but ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY is missing" -}}
{{- end }}
{{- if not $deterministic }}
{{- fail "active record encryption secret exists but ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY is missing" -}}
{{- end }}
{{- if not $salt }}
{{- fail "active record encryption secret exists but ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT is missing" -}}
{{- end }}
{{- else }}
{{- $primary = (randAlphaNum 64 | b64enc) -}}
{{- $deterministic = (randAlphaNum 64 | b64enc) -}}
{{- $salt = (randAlphaNum 64 | b64enc) -}}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ $namespace }}
  labels:
    {{- include "bosun.labels" . | nindent 4 }}
    app.kubernetes.io/component: stern-active-record-encryption
{{- with .Values.global.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
{{- end }}
type: Opaque
data:
  ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY: {{ $primary | quote }}
  ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY: {{ $deterministic | quote }}
  ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT: {{ $salt | quote }}
{{- end }}
